MVP "Электронная очередь для грузовиков с зерном"
#
0. Метаданные для AI‑агента (Codex)
#
Ты — AI‑агент (например, Codex), который должен создать рабочий MVP проекта:
#
Распределённая система электронной очереди для грузовиков с зерном, работающая через два Telegram‑бота и таймерный сервис.
#
Важно:
- Пиши код на Python.
- Используй библиотеку aiogram.
- База данных — SQLite.
- ОС — Ubuntu 24.
- Проект должен быть многомодульным.
- Все три сервиса используют одну БД.
#
После чтения спецификации:
1. Создай структуру проекта.
2. Реализуй модели.
3. Реализуй TruckService.
4. Реализуй ElevatorService.
5. Реализуй NotificationService.
6. Подготовь README.

-------------------------------------------------------
1. Общий обзор системы
-------------------------------------------------------
#
Система включает:
1. TruckService — бот для водителей.
2. ElevatorService — бот для диспетчеров.
3. NotificationService — сервис уведомлений.
#
Функции:
- водитель записывается на разгрузку;
- выбирает дату, слот, элеватор;
- получает уведомления;
- диспетчер отмечает статусы;
- сервис уведомлений отправляет оповещения.

-------------------------------------------------------
2. Архитектура проекта
-------------------------------------------------------
#
2.1 Технологии:
- Python 3.11
- aiogram
- SQLAlchemy
- SQLite
- asyncio
#
2.2 Переменные окружения:
TRUCK_BOT_TOKEN=
ELEVATOR_BOT_TOKEN=
DATABASE_URL=sqlite:///queue.db
NOTIFICATION_POLL_INTERVAL_SECONDS=30
DEFAULT_TIMEZONE=Europe/Moscow

2.3 Структура проекта:
project/
  README.md
  .env.example
  spec-mvp-queue.md
#
  app/
    config.py
    db.py
    models.py
#
    utils/
      time_utils.py
      csv_export.py
#
    truck_bot/
      main.py
      handlers.py
      keyboards.py
      states.py
#
    elevator_bot/
      main.py
      handlers.py
      keyboards.py
#
    notification_service/
      main.py
      logic.py

-------------------------------------------------------
3. Создание Telegram‑ботов
-------------------------------------------------------
#
1. Открыть @BotFather.
2. Выполнить /newbot.
3. Создать бота водителей → TRUCK_BOT_TOKEN.
4. Создать бота диспетчеров → ELEVATOR_BOT_TOKEN.

-------------------------------------------------------
4. Модель данных (SQLite)
-------------------------------------------------------
#
4.1 Таблица elevators:
id
name
work_day_start
work_day_end
bookable_slots_per_day = 5
#
4.2 Таблица drivers:
id
telegram_user_id
telegram_username
created_at
#
4.3 Таблица bookings:
id
driver_id
elevator_id
license_plate
date
slot_start
slot_end
queue_index
status
created_at
arrived_at
unloaded_at
cancelled_at
updated_at
last_notified_queue_index
#
4.4 Таблица notifications:
id
booking_id
notification_type
sent_at

-------------------------------------------------------
5. Логика слотов
-------------------------------------------------------
#
- Рабочие часы: 09:00–17:00
- Слот = 1 час
- Бронируется только 5 слотов в день
- Слоты генерируются на основе:
  - даты
  - рабочего окна
  - уже занятых слотов

-------------------------------------------------------
6. Логика очереди
-------------------------------------------------------
#
При создании записи:
- сохранить бронь
- пересчитать queue_index
#
Опоздание:
- если queue_index = 0
- найти queue_index = 1
- поменять слоты местами
- пересчитать очередь
- сбросить last_notified_queue_index

-------------------------------------------------------
7. TruckService
-------------------------------------------------------
#
Команды:
/start
/book
/my_bookings
/help
#
FSM:
1. Ввод госномера
2. Выбор элеватора
3. Выбор даты
4. Выбор слота
5. Подтверждение

-------------------------------------------------------
8. ElevatorService
-------------------------------------------------------
#
Команды:
/start
/today
/schedule
/export
#
В расписании показывать:
- слот
- госномер
- username
- статус
- очередь
#
Кнопки:
- Прибыл вовремя
- Опоздал
- Разгружен
- Отменить
#
CSV:
license_plate,slot_start,slot_end,is_late,unloaded

-------------------------------------------------------
9. NotificationService
-------------------------------------------------------
#
Цикл:
while True:
    check_notifications()
    sleep(interval)
#
Уведомления:
- CONFIRMED
- REMINDER_24H
- REMINDER_1H
- QUEUE_POSITION_CHANGED

-------------------------------------------------------
10. Время
-------------------------------------------------------
#
DEFAULT_TIMEZONE используется везде.
slot_start, slot_end — timezone aware.

-------------------------------------------------------
11. Требования к качеству кода
-------------------------------------------------------
#
- Строго соблюдать структуру проекта.
- Использовать SQLAlchemy ORM.
- FSM для TruckService.
- Утилиты вынести в utils/.
- Создать README.

-------------------------------------------------------
12. Задача для Codex
-------------------------------------------------------
#
1. Создать структуру проекта.
2. Реализовать config.py, db.py, models.py.
3. Создать TruckService.
4. Создать ElevatorService.
5. Реализовать NotificationService.
6. Реализовать слоты, очередь, swap, уведомления.
7. Создать README.
8. Обеспечить запуск проекта.

